{
  "objects": [
    {
      "name": "load_schedule",
      "id": "ScheduleObject",
      "startAt": "FIRST_ACTIVATION_DATE_TIME",
      "period": "2 Hours",
      "type": "Schedule"
    },
    {
      "name": "Default",
      "id": "Default",
      "failureAndRerunMode": "CASCADE",
      "scheduleType": "cron",
      "role": "DataPipelineDefaultRole",
      "resourceRole": "DataPipelineDefaultResourceRole",
      "pipelineLogUri": "s3://sample-logs/data_pipeline_logs/sample/",
      "schedule": { "ref": "ScheduleObject" },
      "onFail": { "ref": "FailureAlarm" }
    },
    {
      "name": "Failure Alarm",
      "id": "FailureAlarm",
      "message": "There was a problem executing #{node.name} at for period #{node.@scheduledStartTime} to #{node.@scheduledEndTime}",
      "subject": "RDS to Redshift copy failed",
      "topicArn": "arn:aws:sns:us-east-1:id:redshift-debug",
      "type": "SnsAlarm"
    },
    {
      "name": "RDS Dump Resource",
      "id": "RDSDumpEc2Resource",
      "terminateAfter": "4 Hours",
      "securityGroups": "sample_data_pipeline",
      "maximumRetries": "1",
      "maxActiveInstances": "1",
      "logUri": "s3://sample-logs/data_pipeline_logs/sample/#{type}/#{name}",
      "type": "Ec2Resource"
    },
    {
      "name": "Redshift Load Resource",
      "id": "RedshiftLoadEc2Resource",
      "terminateAfter": "4 Hours",
      "securityGroups": "sample_data_pipeline",
      "maximumRetries": "1",
      "maxActiveInstances": "1",
      "logUri": "s3://sample-logs/data_pipeline_logs/sample/#{type}/#{name}",
      "type": "Ec2Resource"
    },
    {
      "name": "Redshift",
      "id": "RedshiftDatabaseObject",
      "databaseName": "sample",
      "username": "user",
      "*password": "pass",
      "jdbcProperties": "logLevel=2",
      "clusterId": "redshift1",
      "type": "RedshiftDatabase"
    },
    {
      "name": "Mysql",
      "id": "MysqlDatabaseObject",
      "databaseName": "sample",
      "username": "user",
      "*password": "pass",
      "rdsInstanceId": "rds1",
      "type": "RdsDatabase",
      "jdbcProperties": ["zeroDateTimeBehavior=convertToNull", "connectTimeout=0", "socketTimeout=0"]
    },
    {
      "name": "csv_data_format",
      "id": "DataFormat",
      "type": "CSV"
    },

    {
      "name": "RDS: table_one",
      "id": "table_oneMySqlDataNode",
      "table": "table_one",
      "selectQuery": "select id,name,left(notes,500),created_at,updated_at from #{table} where updated_at > '#{format(minusHours(@scheduledStartTime,48),'YYYY-MM-dd hh:mm:ss')}'",
      "type": "MySqlDataNode",
      "database": {
        "ref": "MysqlDatabaseId_RsqsB"
      }
    },
    {
      "name": "table_one to S3",
      "id": "table_oneToS3CopyActivity",
      "input": {
        "ref": "table_oneMySqlDataNode"
      },
      "maximumRetries": "1",
      "runsOn": {
        "ref": "RDSDumpEc2Resource"
      },
      "output": {
        "ref": "table_one3DataNode"
      },
      "type": "CopyActivity"
    },
    {
      "name": "S3: table_one",
      "id": "table_one3DataNode",
      "filePath": "s3://sample-logs/data_pipeline_output/table_one/#{@scheduledStartTime}.csv.gz",
      "dataFormat": {
        "ref": "DataFormatId_Iz13M"
      },
      "compression": "GZIP",
      "type": "S3DataNode"
    },
    {
      "name": "S3 to Redshift: table_one",
      "id": "table_oneToRedshiftCopyActivity",
      "input": {
        "ref": "table_one3DataNode"
      },
      "insertMode": "OVERWRITE_EXISTING",
      "maximumRetries": "1",
      "runsOn": {
        "ref": "RedshiftLoadEc2Resource"
      },
      "output": {
        "ref": "table_oneRedshiftDataNode"
      },
      "type": "RedshiftCopyActivity"
    },
    {
      "name": "Redshift: table_one",
      "id": "table_oneRedshiftDataNode",
      "tableName": "table_one",
      "type": "RedshiftDataNode",
      "database": {
        "ref": "RedshiftDatabaseId_RsqsB"
      }
    },

    {
      "name": "RDS: table_two",
      "id": "table_twoMySqlDataNode",
      "table": "table_two",
      "selectQuery": "select * from #{table} where updated_at > '#{format(minusHours(@scheduledStartTime,48),'YYYY-MM-dd hh:mm:ss')}'",
      "type": "MySqlDataNode",
      "database": {
        "ref": "MysqlDatabaseId_RsqsB"
      }
    },
    {
      "name": "table_two to S3",
      "id": "table_twoToS3CopyActivity",
      "input": {
        "ref": "table_twoMySqlDataNode"
      },
      "maximumRetries": "1",
      "runsOn": {
        "ref": "RDSDumpEc2Resource"
      },
      "dependsOn": {
        "ref": "table_oneToS3CopyActivity"
      },
      "output": {
        "ref": "table_two3DataNode"
      },
      "type": "CopyActivity"
    },
    {
      "name": "S3: table_two",
      "id": "table_two3DataNode",
      "filePath": "s3://sample-logs/data_pipeline_output/table_two/#{@scheduledStartTime}.csv.gz",
      "dataFormat": {
        "ref": "DataFormatId_Iz13M"
      },
      "compression": "GZIP",
      "type": "S3DataNode"
    },
    {
      "name": "S3 to Redshift: table_two",
      "id": "table_twoToRedshiftCopyActivity",
      "input": {
        "ref": "table_two3DataNode"
      },
      "insertMode": "OVERWRITE_EXISTING",
      "maximumRetries": "1",
      "runsOn": {
        "ref": "RedshiftLoadEc2Resource"
      },
      "output": {
        "ref": "table_twoRedshiftDataNode"
      },
      "type": "RedshiftCopyActivity"
    },
    {
      "name": "Redshift: table_two",
      "id": "table_twoRedshiftDataNode",
      "tableName": "table_two",
      "type": "RedshiftDataNode",
      "database": {
        "ref": "RedshiftDatabaseId_RsqsB"
      }
    },

    {
      "name": "RDS: table_three",
      "id": "table_threeMySqlDataNode",
      "table": "table_three",
      "selectQuery": "select * from #{table} where updated_at > '#{format(minusHours(@scheduledStartTime,48),'YYYY-MM-dd hh:mm:ss')}'",
      "type": "MySqlDataNode",
      "database": {
        "ref": "MysqlDatabaseId_RsqsB"
      }
    },
    {
      "name": "table_three to S3",
      "id": "table_threeToS3CopyActivity",
      "input": {
        "ref": "table_threeMySqlDataNode"
      },
      "maximumRetries": "1",
      "runsOn": {
        "ref": "RDSDumpEc2Resource"
      },
      "dependsOn": {
        "ref": "table_twoToS3CopyActivity"
      },
      "output": {
        "ref": "table_three3DataNode"
      },
      "type": "CopyActivity"
    },
    {
      "name": "S3: table_three",
      "id": "table_three3DataNode",
      "filePath": "s3://sample-logs/data_pipeline_output/table_three/#{@scheduledStartTime}.csv.gz",
      "dataFormat": {
        "ref": "DataFormatId_Iz13M"
      },
      "compression": "GZIP",
      "type": "S3DataNode"
    },
    {
      "name": "S3 to Redshift: table_three",
      "id": "table_threeToRedshiftCopyActivity",
      "input": {
        "ref": "table_three3DataNode"
      },
      "insertMode": "OVERWRITE_EXISTING",
      "maximumRetries": "1",
      "runsOn": {
        "ref": "RedshiftLoadEc2Resource"
      },
      "output": {
        "ref": "table_threeRedshiftDataNode"
      },
      "type": "RedshiftCopyActivity"
    },
    {
      "name": "Redshift: table_three",
      "id": "table_threeRedshiftDataNode",
      "tableName": "table_three",
      "type": "RedshiftDataNode",
      "database": {
        "ref": "RedshiftDatabaseId_RsqsB"
      }
    }

  ]
}
